<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llama.cpp 模型管理系统</title>
    <link rel="stylesheet" href="css/all.min.css">
    <link href="css/css2.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo 600 */
            --primary-hover: #4338ca;
            --bg-color: #f3f4f6; /* Gray 100 */
            --sidebar-bg: #ffffff;
            --border-color: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --card-bg: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 0.5rem;
            --transition-speed: 0.2s;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 20;
            flex-shrink: 0;
            box-shadow: 2px 0 8px rgba(0,0,0,0.02);
        }

        .sidebar-header {
            height: 64px;
            padding: 0 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
        }

        .app-logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }
        
        .app-logo i { font-size: 1.5rem; }

        .sidebar-nav {
            flex: 1;
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            color: var(--text-secondary);
            text-decoration: none;
            transition: all var(--transition-speed);
            font-weight: 500;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .nav-item i { width: 1.25rem; text-align: center; }

        .nav-item:hover {
            background-color: #f9fafb;
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background-color: #eff6ff; /* Blue 50 */
            color: var(--primary-color);
        }
        
        .nav-item.danger { color: var(--danger-color); }
        .nav-item.danger:hover { background-color: #fef2f2; }

        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            background-color: #f9fafb;
        }

        /* Main Area */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--bg-color);
        }

        .top-bar {
            height: 64px;
            padding: 0 2rem;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            z-index: 10;
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .top-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-box {
            position: relative;
            width: 320px;
        }

        .search-input {
            width: 100%;
            padding: 0.625rem 1rem 0.625rem 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: 9999px;
            font-size: 0.875rem;
            outline: none;
            transition: all 0.2s;
            background-color: white;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Content */
        .content-scrollable {
            flex: 1;
            overflow-y: auto;
            padding: 0 2rem 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 1.25rem;
            transition: transform 0.2s;
        }
        
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background-color: #eff6ff;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-info h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
            margin-bottom: 0.25rem;
        }

        .stat-info p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Model List */
        .model-list-container {
            background: var(--card-bg);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
        }

        .model-list-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            position: sticky;
            top: 0;
            z-index: 5;
        }
        
        .model-list-header h2 { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); }

        .model-item {
            display: flex;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .model-item:last-child { border-bottom: none; }
        .model-item:hover { background-color: #f9fafb; }

        .model-fav-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid transparent;
            background: transparent;
            color: #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-right: 0.75rem;
            font-size: 1rem;
        }
        .model-fav-btn:hover {
            border-color: var(--border-color);
            background: #ffffff;
            color: var(--warning-color);
        }
        .model-fav-btn.active {
            color: var(--warning-color);
        }

        .model-icon-wrapper {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            overflow: hidden;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1.25rem;
            font-size: 1.5rem;
            color: var(--text-secondary);
            flex-shrink: 0;
            border: 1px solid var(--border-color);
        }
        .model-icon-wrapper img { width: 100%; height: 100%; object-fit: cover; }

        .model-details {
            flex: 1;
            min-width: 0;
            margin-right: 1rem;
        }

        .model-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.375rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .model-name:hover { color: var(--primary-color); }
        
        .vision-badge {
            color: var(--info-color);
            background-color: #eff6ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .model-meta {
            display: flex;
            gap: 1.25rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .model-meta span { display: flex; align-items: center; gap: 0.375rem; }
        .model-meta i { font-size: 0.875rem; opacity: 0.7; }

        .model-status-badge {
            padding: 0.375rem 0.875rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 100px;
            justify-content: center;
        }
        .status-running { background-color: #dcfce7; color: #166534; }
        .status-stopped { background-color: #f3f4f6; color: #4b5563; }
        .status-loading { background-color: #fef3c7; color: #92400e; }
        .status-loaded { background-color: #e0e7ff; color: #3730a3; }

        .model-actions {
            display: flex;
            gap: 0.75rem;
            margin-left: 1.5rem;
        }

        .btn-icon {
            width: 38px;
            height: 38px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: white;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }
        .btn-icon:hover { border-color: var(--primary-color); color: var(--primary-color); transform: translateY(-1px); }
        .btn-icon.danger:hover { border-color: var(--danger-color); color: var(--danger-color); background-color: #fef2f2; }
        .btn-icon.primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-icon.primary:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); color: white; }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.2s ease-out;
            border: 1px solid var(--border-color);
        }
        .modal-content.model-detail { width: 95%; max-width: 1000px; }
        .modal-content.slots-modal { width: 95%; max-width: 1200px; max-height: 85vh; }
        .modal-content.load-model-modal { width: 95%; max-width: 1200px; }
        #slotsModal .modal-body { overflow: hidden; display: flex; flex-direction: column; }

        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            line-height: 1;
        }
        .modal-close:hover { color: var(--text-primary); }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        #settingsModal .modal-body {
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-footer {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            background-color: #f9fafb;
            border-radius: 0 0 1rem 1rem;
        }

        /* Forms */
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-primary); }
        .form-control {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        .form-control:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .form-text { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.375rem; }
        
        .form-check { display: flex; align-items: center; margin-bottom: 0.75rem; }
        .form-check-input { margin-right: 0.5rem; width: 1rem; height: 1rem; }
        .form-check-label { font-size: 0.875rem; color: var(--text-primary); }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            gap: 0.5rem;
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .btn-secondary { background-color: white; border-color: var(--border-color); color: var(--text-primary); }
        .btn-secondary:hover { background-color: #f9fafb; border-color: #d1d5db; }
        
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #dc2626; }

        /* Toasts */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            box-shadow: var(--shadow-md);
            padding: 1rem;
            border-radius: var(--radius);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            min-width: 320px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid transparent;
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .toast.success { border-left-color: var(--success-color); }
        .toast.error { border-left-color: var(--danger-color); }
        .toast.warning { border-left-color: var(--warning-color); }
        .toast.info { border-left-color: var(--info-color); }

        .toast-icon { font-size: 1.25rem; margin-top: 2px; }
        .toast.success .toast-icon { color: var(--success-color); }
        .toast.error .toast-icon { color: var(--danger-color); }
        .toast.warning .toast-icon { color: var(--warning-color); }
        .toast.info .toast-icon { color: var(--info-color); }

        .toast-content { flex: 1; }
        .toast-title { font-weight: 600; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--text-primary); }
        .toast-message { font-size: 0.875rem; color: var(--text-secondary); }

        .toast-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1rem; }
        .toast-close:hover { color: var(--text-primary); }

        /* Loading Spinner */
        .loading-spinner { display: flex; justify-content: center; align-items: center; padding: 2rem; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Empty State */
        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-secondary); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.3; }
        .empty-state-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary); }
        .empty-state-text { font-size: 0.875rem; }
        
        /* Specific Styles */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; height: 100%; }
        .settings-panel { border: 1px solid var(--border-color); border-radius: 0.75rem; display: flex; flex-direction: column; overflow: hidden; background-color: #ffffff; box-shadow: 0 10px 15px -10px rgba(15, 23, 42, 0.15); }
        .panel-header { padding: 0.9rem 1rem; background: #f9fafb; border-bottom: 1px solid var(--border-color); font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; }
        .panel-body { padding: 1rem; flex: 1; overflow-y: auto; }

        .settings-section-header { margin-bottom: 1rem; }
        .settings-section-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; }
        .settings-section-subtitle { font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem; }

        .settings-actions-row { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }

        .settings-list {
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 0.5rem 0.75rem;
            min-height: 150px;
            max-height: 45vh;
            overflow-y: auto;
            background-color: #f9fafb;
        }

        #settingsModal .settings-grid {
            flex: 1;
            min-height: 0;
        }

        #settingsModal .panel-body {
            flex: 1;
            overflow: hidden;
        }

        #settingsModal #settingsFormLeft,
        #settingsModal #settingsFormRight {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #settingsModal #settingsFormLeft .form-group:last-child,
        #settingsModal #settingsFormRight .form-group:last-child {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        #settingsModal .settings-list {
            flex: 1;
            max-height: none;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.4rem 0.25rem;
            gap: 0.75rem;
        }

        .settings-item-main {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 0;
        }

        .settings-item-icon {
            flex: 0 0 24px;
            width: 24px;
            height: 24px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ffffff;
            color: var(--primary-color);
            border: 1px solid rgba(148, 163, 184, 0.4);
            font-size: 0.75rem;
        }

        .settings-item-text {
            flex: 1 1 auto;
            font-size: 0.8125rem;
            color: var(--text-primary);
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .settings-empty {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            padding: 0.5rem 0.25rem;
        }

        .settings-item .btn-icon {
            flex: 0 0 38px;
        }
        
        @media (max-width: 768px) {
            .settings-grid { grid-template-columns: 1fr; }
            .sidebar { display: none; } /* Mobile sidebar not implemented yet for brevity */
        }
        
        /* Console Log Styles */
        #logContainer::-webkit-scrollbar { width: 8px; height: 8px; }
        #logContainer::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        #logContainer::-webkit-scrollbar-track { background: #1e293b; }
        /* Force Font Awesome spinner animation even when user prefers reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .fa-spin { animation: fa-spin 2s linear infinite !important; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="#" class="app-logo">
                <i class="fas fa-brain"></i>
                <span>Llama Manager</span>
            </a>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" onclick="refreshModels(); return false;">
                <i class="fas fa-cubes"></i>
                <span>模型列表</span>
            </a>
            <a href="chat/completion.html" class="nav-item" target="_blank">
                <i class="fas fa-comments"></i>
                <span>对话界面</span>
            </a>
            <a href="chat/concurrency.html" class="nav-item" target="_blank">
                <i class="fas fa-comments"></i>
                <span>压力测试</span>
            </a>
            <a href="download.html" class="nav-item">
                <i class="fas fa-download"></i>
                <span>下载管理</span>
            </a>
            <a href="#" class="nav-item" onclick="openConsoleModal(); return false;">
                <i class="fas fa-terminal"></i>
                <span>控制台日志</span>
            </a>
            <a href="#" class="nav-item" onclick="openSettingsModal(); return false;">
                <i class="fas fa-cog"></i>
                <span>系统设置</span>
            </a>
            <div style="flex: 1"></div>
             <a href="#" class="nav-item danger" onclick="shutdownService(); return false;">
                <i class="fas fa-power-off"></i>
                <span>停止服务</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                Llama.cpp Server<br>v1.0.0
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-area">
        <!-- Top Bar -->
        <div class="top-bar">
            <h1 class="page-title">模型管理</h1>
            <div class="top-actions">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="modelSearchInput" class="search-input" placeholder="搜索模型...">
                </div>
                <button class="btn btn-secondary" onclick="refreshModels()" title="刷新列表">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Scrollable Content -->
        <div class="content-scrollable">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="loadedModelsCount">0</h3>
                        <p>已加载模型</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalModelsCount">0</h3>
                        <p>模型总数</p>
                    </div>
                </div>
            </div>

            <!-- Model List -->
            <div class="model-list-container">
                <div class="model-list-header">
                    <h2>所有模型</h2>
                    <div style="margin-left: auto;">
                        <select id="modelSortSelect" class="form-control" style="padding: 4px 8px; width: auto; font-size: 0.875rem;" onchange="sortAndRenderModels()">
                            <option value="name_asc">名称 (A-Z)</option>
                            <option value="name_desc">名称 (Z-A)</option>
                            <option value="size_asc">文件大小 (小到大)</option>
                            <option value="size_desc">文件大小 (大到小)</option>
                            <option value="params_asc">参数量 (小到大)</option>
                            <option value="params_desc">参数量 (大到小)</option>
                        </select>
                    </div>
                </div>
                <div id="modelsList">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Load Model Modal -->
    <div class="modal" id="loadModelModal">
        <div class="modal-content load-model-modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-upload" id="modelActionModalIcon"></i> <span id="modelActionModalTitleText">加载模型</span></h3>
                <button class="modal-close" onclick="closeModal('loadModelModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="loadModelForm">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; align-items: start;">
                        <div>
                            <div class="form-group">
                                <label class="form-label" for="modelId">模型ID</label>
                                <input type="text" class="form-control" id="modelId" name="modelId" readonly style="background-color: #f3f4f6; display: none;">
                                <input type="text" class="form-control" id="modelName" name="modelName" readonly style="background-color: #f3f4f6;">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="ctxSize">上下文大小 (ctx-size)</label>
                                <input type="number" class="form-control" id="ctxSize" name="ctxSize" min="1" placeholder="例如: 2048" value="32768">
                                <small class="form-text">模型的最大上下文长度</small>
                                <small class="form-text" id="ctxSizeVramHint" style="color: var(--success-color);"></small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="llamaBinPathSelect">Llama.cpp 版本</label>
                                <select class="form-control" id="llamaBinPathSelect" name="llamaBinPathSelect"></select>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="noMmap" name="noMmap" checked>
                                    <label class="form-check-label" for="noMmap">禁用内存映射 (no-mmap)</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="mlock" name="mlock">
                                    <label class="form-check-label" for="mlock">锁定内存 (mlock)</label>
                                </div>
                                <div class="form-check" id="enableVisionGroup" style="display: none;">
                                    <input type="checkbox" class="form-check-input" id="enableVision" name="enableVision" checked>
                                    <label class="form-check-label" for="enableVision">开启视觉</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="embedding" name="embedding">
                                    <label class="form-check-label" for="embedding">Embedding模式</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="reranking" name="reranking">
                                    <label class="form-check-label" for="reranking">Reranking模式</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="flashAttention" name="flashAttention" checked>
                                    <label class="form-check-label" for="flashAttention">Flash Attention</label>
                                </div>
                            </div>
                            <details style="margin-top: 1rem; border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.5rem;">
                                <summary style="cursor: pointer; font-size: 0.875rem; color: var(--primary-color); font-weight: 500;">高级参数 (Temperature, Top-P, etc.)</summary>
                                <div style="padding-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label" for="temperature">Temperature</label>
                                        <input type="number" step="0.01" class="form-control" id="temperature" name="temperature" value="0.7">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="topP">Top P</label>
                                        <input type="number" step="0.01" class="form-control" id="topP" name="topP" value="0.95">
                                    </div>
                                     <div class="form-group">
                                        <label class="form-label" for="topK">Top K</label>
                                        <input type="number" class="form-control" id="topK" name="topK" value="40">
                                    </div>
                                     <div class="form-group">
                                        <label class="form-label" for="minP">Min P</label>
                                        <input type="number" step="0.01" class="form-control" id="minP" name="minP" value="0.05">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="presencePenalty">Presence Penalty</label>
                                        <input type="number" step="0.01" class="form-control" id="presencePenalty" name="presencePenalty" value="0.0">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="repeatPenalty">Repeat Penalty</label>
                                        <input type="number" step="0.01" class="form-control" id="repeatPenalty" name="repeatPenalty" value="1.10">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="batchSize">batch-size</label>
                                        <input type="number" class="form-control" id="batchSize" name="batchSize" min="1" placeholder="例如: 512" value="1024">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="ubatchSize">ubatch-size</label>
                                        <input type="number" class="form-control" id="ubatchSize" name="ubatchSize" min="1" placeholder="例如: 512" value="2048">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="parallel">parallel</label>
                                        <input type="number" class="form-control" id="parallel" name="parallel" min="1" placeholder="例如: 4" value="4">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label class="form-label" for="extraParams">额外参数</label>
                                    <textarea class="form-control" id="extraParams" name="extraParams" rows="2" placeholder="例如: --grp-attn-n 8 --grp-attn-w 512"></textarea>
                                    <small class="form-text">输入额外的命令行参数，用空格分隔</small>
                                </div>
                            </details>
                        </div>
                        <div>
                            <div class="form-group">
                                <label class="form-label" for="mainGpuSelect">主GPU (main-gpu)</label>
                                <select class="form-control" id="mainGpuSelect" name="mg">
                                    <option value="-1">默认</option>
                                </select>
                                <small class="form-text">选择 llama.cpp 运行所使用的主要 GPU（INDEX，从 0 开始）</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">可用计算设备</label>
                                <small class="form-text">默认已勾选全部设备；取消勾选可排除设备</small>
                                <div id="deviceChecklist" style="border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 0.75rem; max-height: 260px; overflow: auto;">
                                    <div class="settings-empty">请先选择 Llama.cpp 版本</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('loadModelModal')">取消</button>
                <button class="btn btn-secondary" onclick="estimateVramAction()"><i class="fas fa-memory"></i> 估算显存</button>
                <button class="btn btn-primary" id="modelActionSubmitBtn" onclick="submitModelAction()">加载模型</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-cog"></i> 系统设置</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section-header">
                    <div class="settings-section-title">
                        <i class="fas fa-sliders-h"></i>
                        <span>全局路径设置</span>
                    </div>
                    <div class="settings-section-subtitle">
                        配置模型根目录和已编译的 llama.cpp 路径，供模型加载与运行使用。
                    </div>
                </div>
                <div class="settings-grid">
                    <div class="settings-panel">
                        <div class="panel-header">
                            <i class="fas fa-folder-open"></i>
                            <span>模型目录</span>
                        </div>
                        <div class="panel-body">
                            <form id="settingsFormLeft">
                                <div class="form-group">
                                    <div class="settings-actions-row">
                                        <button type="button" class="btn btn-primary" onclick="openAddModelPathModal()"><i class="fas fa-plus"></i></button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div id="modelPathListContainer" class="settings-list"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="settings-panel">
                        <div class="panel-header">
                            <i class="fas fa-microchip"></i>
                            <span>Llama.cpp 路径</span>
                        </div>
                        <div class="panel-body">
                            <form id="settingsFormRight">
                                <div class="form-group">
                                    <div class="settings-actions-row">
                                        <button type="button" class="btn btn-primary" onclick="openAddLlamaCppPathModal()"><i class="fas fa-plus"></i></button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div id="llamaCppListContainer" class="settings-list"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('settingsModal')">取消</button>
                <button class="btn btn-primary" onclick="saveSettings()">保存更改</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addModelPathModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">添加模型目录</h3>
                <button class="modal-close" onclick="closeModal('addModelPathModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">目录路径</label>
                    <input class="form-control" id="addModelPathInput" placeholder="/path/to/models">
                    <small class="form-text">支持多个模型根目录，将合并检索其中所有 GGUF 模型。</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addModelPathModal')">取消</button>
                <button class="btn btn-primary" onclick="addModelPath()">保存</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addLlamaCppPathModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">添加 Llama.cpp 路径</h3>
                <button class="modal-close" onclick="closeModal('addLlamaCppPathModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">目录路径</label>
                    <input class="form-control" id="addLlamaCppPathInput" placeholder="/path/to/llama.cpp">
                    <small class="form-text">输入已编译的 llama.cpp 根目录路径。</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addLlamaCppPathModal')">取消</button>
                <button class="btn btn-primary" onclick="addLlamaCppPath()">保存</button>
            </div>
        </div>
    </div>

    <!-- Console Modal -->
    <div class="modal" id="consoleModal">
        <div class="modal-content" style="max-width: 1000px; height: 85vh;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-terminal"></i> 控制台输出</h3>
                <button class="modal-close" onclick="closeModal('consoleModal')">&times;</button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; padding: 0;">
                <div style="display:flex; align-items:center; gap:12px; padding:12px; border-bottom:1px solid var(--border-color); background: #f8f9fa;">
                    <button class="btn btn-secondary btn-sm" id="refreshConsoleBtn"><i class="fas fa-sync-alt"></i> 刷新</button>
                    <label style="display:inline-flex; align-items:center; gap:6px; font-size: 14px;">
                        <input type="checkbox" id="autoRefreshConsole"> 自动刷新
                    </label>
                    <label style="display:inline-flex; align-items:center; gap:6px; font-size: 14px;">
                        间隔(ms)
                        <input class="form-control" type="number" id="intervalConsoleInput" value="2000" min="500" style="width:80px; padding: 4px 8px;">
                    </label>
                    <div id="consoleStatusText" style="font-size:12px; color:var(--text-secondary); margin-left:auto;"></div>
                </div>
                <div id="logContainer" style="flex: 1; overflow:auto; padding:16px; font-family:'Menlo', 'Monaco', 'Courier New', monospace; background:#0f172a; color:#e5e7eb; font-size: 0.875rem;">
                    <pre id="consoleContent" style="margin:0; white-space:pre-wrap; word-break:break-word;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('consoleModal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="js/websocket.js"></script>
    <script src="js/console-modal.js"></script>
    <script>
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            loadModels();
            initWebSocket();
            initModelSearch();
        });

        function formatFileSize(size) {
            if (size < 1024) return size + ' B';
            if (size < 1024 * 1024) return (size / 1024).toFixed(1) + ' KB';
            if (size < 1024 * 1024 * 1024) return (size / (1024 * 1024)).toFixed(1) + ' MB';
            return (size / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        function openSlotsModal(modelId, displayName) {
            const modalId = 'slotsModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content slots-modal">
                        <div class="modal-header">
                            <h3 class="modal-title">缓存管理 - ${displayName}</h3>
                            <button class="modal-close" onclick="closeModal('${modalId}')">&times;</button>
                        </div>
                        <div class="modal-body" id="${modalId}Content">
                            <div style="padding: 12px;">加载中...</div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('${modalId}')">关闭</button>
                            <button class="btn btn-primary" onclick="saveSelectedSlot('${modelId}')">保存</button>
                            <button class="btn btn-primary" onclick="loadSelectedSlot('${modelId}')">读取</button>
                            <button class="btn btn-primary" onclick="fetchSlotsForModel('${modelId}')">刷新</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
            }
            modal.classList.add('show');
            fetchSlotsForModel(modelId);
        }

        function fetchSlotsForModel(modelId) {
            const container = document.getElementById('slotsModalContent');
            fetch(`/api/models/slots/get?modelId=${encodeURIComponent(modelId)}`)
                .then(r => r.json())
                .then(d => {
                    if (!d.success) {
                        const el = document.getElementById('slotsModalContent') || document.getElementById('slotsModal').querySelector('.modal-body');
                        if (el) el.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="empty-state-title">加载失败</div><div class="empty-state-text">${d.error || '未知错误'}</div></div>`;
                        return;
                    }
                    const slots = (d.data && d.data.slots) ? d.data.slots : [];
                    renderSlotsContent(slots);
                })
                .catch(e => {
                    const el = document.getElementById('slotsModalContent') || document.getElementById('slotsModal').querySelector('.modal-body');
                    if (el) el.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="empty-state-title">网络错误</div><div class="empty-state-text">${e.message || ''}</div></div>`;
                });
        }

        function saveSelectedSlot(modelId) {
            const selectEl = document.getElementById('slotSelect');
            const slots = window.__slotsData || [];
            if (!selectEl || !slots.length) {
                showToast('错误', '未找到可保存的Slot', 'error');
                return;
            }
            const idx = parseInt(selectEl.value, 10) || 0;
            const slot = slots[idx];
            if (!slot && idx < 0) {
                showToast('错误', '未选择有效的Slot', 'error');
                return;
            }
            let slotId = slot && slot.id !== undefined ? slot.id : idx;
            slotId = parseInt(slotId, 10);
            if (Number.isNaN(slotId)) slotId = idx;
            fetch('/api/models/slots/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ modelId, slotId })
            }).then(r => r.json()).then(res => {
                if (res && res.success) {
                    showToast('成功', '保存成功', 'success');
                } else {
                    showToast('错误', (res && res.error) ? res.error : '保存失败', 'error');
                }
            }).catch(() => {
                showToast('错误', '网络请求失败', 'error');
            });
        }
        
        function loadSelectedSlot(modelId) {
            const selectEl = document.getElementById('slotSelect');
            const slots = window.__slotsData || [];
            if (!selectEl || !slots.length) {
                showToast('错误', '未找到可读取的Slot', 'error');
                return;
            }
            const idx = parseInt(selectEl.value, 10) || 0;
            const slot = slots[idx];
            if (!slot && idx < 0) {
                showToast('错误', '未选择有效的Slot', 'error');
                return;
            }
            let slotId = slot && slot.id !== undefined ? slot.id : idx;
            slotId = parseInt(slotId, 10);
            if (Number.isNaN(slotId)) slotId = idx;
            fetch('/api/models/slots/load', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ modelId, slotId })
            }).then(r => r.json()).then(res => {
                if (res && res.success) {
                    showToast('成功', '读取成功', 'success');
                } else {
                    showToast('错误', (res && res.error) ? res.error : '读取失败', 'error');
                }
            }).catch(() => {
                showToast('错误', '网络请求失败', 'error');
            });
        }

        function renderSlotsContent(slots) {
            const modal = document.getElementById('slotsModal');
            const body = document.getElementById('slotsModalContent') || (modal ? modal.querySelector('.modal-body') : null);
            if (!body) return;
            if (!slots || !slots.length) {
                body.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-database"></i></div><div class="empty-state-title">无可用Slot</div><div class="empty-state-text">当前模型没有可用的处理槽位</div></div>`;
                return;
            }
            window.__slotsData = slots;
            const prevIndex = (() => {
                const sel = document.getElementById('slotSelect');
                if (sel && sel.value !== '') {
                    const v = parseInt(sel.value, 10);
                    if (!Number.isNaN(v)) return v;
                }
                return 0;
            })();
            let html = '';
            html += `<div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">`;
            html += `<label class="form-label" for="slotSelect" style="margin:0;">选择 Slot</label>`;
            html += `<select class="form-control" id="slotSelect" style="max-width:320px;">`;
            slots.forEach((s, idx) => {
                const id = s.id !== undefined ? s.id : idx;
                const running = s.is_processing ? '处理中' : '空闲';
                const nctx = s.n_ctx !== undefined ? s.n_ctx : '';
                html += `<option value="${idx}">ID ${id} · ${running} · ctx ${nctx}</option>`;
            });
            html += `</select>`;
            html += `</div>`;
            html += `<pre id="slotJsonViewer" style="flex:1; min-height:0; overflow:auto; font-size:13px; background:#111827; color:#e5e7eb; padding:10px; border-radius:0.75rem;"></pre>`;
            body.id = 'slotsModalContent';
            body.innerHTML = html;
            const selectEl = document.getElementById('slotSelect');
            if (selectEl) {
                const idx = Math.min(Math.max(prevIndex, 0), slots.length - 1);
                selectEl.selectedIndex = idx;
                selectEl.onchange = updateSlotJsonViewer;
            }
            updateSlotJsonViewer();
        }

        function updateSlotJsonViewer() {
            const slots = window.__slotsData || [];
            const selectEl = document.getElementById('slotSelect');
            const viewer = document.getElementById('slotJsonViewer');
            if (!selectEl || !viewer || !slots.length) return;
            const idx = parseInt(selectEl.value, 10) || 0;
            const slot = slots[idx];
            if (!slot) {
                viewer.textContent = '';
                return;
            }
            try {
                viewer.textContent = JSON.stringify(slot, null, 2);
            } catch (e) {
                viewer.textContent = '';
            }
        }

        function showModelLoadingState(modelId) {
             let loadingToast = document.getElementById('loading-toast-' + modelId);
            if (!loadingToast) {
                const toastContainer = document.getElementById('toastContainer');
                const toastHtml = `
                    <div class="toast info" id="loading-toast-${modelId}">
                        <div class="toast-icon"><i class="fas fa-spinner fa-spin"></i></div>
                        <div class="toast-content"><div class="toast-title">加载中</div><div class="toast-message">正在加载...</div></div>
                    </div>`;
                toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            }
        }
        function removeModelLoadingState(modelId) {
            const el = document.getElementById('loading-toast-' + modelId);
            if (el) el.remove();
        }

        function stopModel(modelId) {
             fetch('/api/models/stop', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ modelId })
            }).then(r => r.json()).then(d => {
                if (!d.success) showToast('错误', d.error, 'error');
            });
        }

        function viewModelDetails(modelId) {
            fetch(`/api/models/details?modelId=${modelId}`).then(r => r.json()).then(data => {
                if (data.success) {
                    const model = data.model;
                    window.__modelDetailModelId = modelId;
                    showModelDetailModal(model);
                } else { showToast('错误', data.error, 'error'); }
            });
        }
        
        function showModelDetailModal(model) {
            const modalId = 'modelDetailModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div'); modal.id = modalId; modal.className = 'modal';
                modal.innerHTML = `<div class="modal-content model-detail"><div class="modal-header"><h3 class="modal-title">模型详情</h3><button class="modal-close" onclick="closeModal('${modalId}')">&times;</button></div><div class="modal-body" id="${modalId}Content"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('${modalId}')">关闭</button></div></div>`;
                document.body.appendChild(modal);
            }
            const content = document.getElementById(modalId + 'Content');
            let tabs = `<div style="display:flex; gap:8px; margin-bottom:12px;">` +
                        `<button class="btn btn-secondary" id="${modalId}TabInfo">概览</button>` +
                        `<button class="btn btn-secondary" id="${modalId}TabMetrics">metrics</button>` +
                        `<button class="btn btn-secondary" id="${modalId}TabProps">props</button>` +
                        `</div>`;
            let wrapperStart = `<div style="display:flex; flex-direction:column; height:60vh; min-height:60vh;">`;
            let bodyStart = `<div style="flex:1; min-height:0;">`;
            let infoPanel = `<div id="${modalId}InfoPanel" style="height:100%;">` +
                            `<div style="display:grid; grid-template-columns: 1fr 2fr; gap: 10px; height:100%; overflow:auto;">` +
                            `<div><strong>名称:</strong></div><div>${model.name}</div>` +
                            `<div><strong>路径:</strong></div><div style="word-break:break-all;">${model.path}</div>` +
                            `<div><strong>大小:</strong></div><div>${formatFileSize(model.size)}</div>` +
                            `${model.isLoaded ? `<div><strong>状态:</strong></div><div>已启动${model.port ? `（端口 ${model.port}）` : ''}</div>` : `<div><strong>状态:</strong></div><div>未启动</div>`}` +
                            `${model.startCmd ? `<div><strong>启动命令:</strong></div><div style="word-break:break-all; font-family: monospace;">${model.startCmd}</div>` : ``}` +
                            `${(() => { let s=''; if (model.metadata) { for (const [k,v] of Object.entries(model.metadata)) { s += `<div><strong>${k}:</strong></div><div style="word-break:break-all;">${v}</div>`; } } return s; })()}` +
                            `</div>` +
                            `</div>`;
            let metricsPanel = `<div id="${modalId}MetricsPanel" style="display:none; height:100%;">` +
                               `<div style="display:flex; gap:8px; margin-bottom:8px;">` +
                               `<button class="btn btn-primary" id="${modalId}MetricsFetchBtn">请求 metrics</button>` +
                               `</div>` +
                               `<pre id="${modalId}MetricsViewer" style="height:calc(100% - 48px); overflow:auto; font-size:13px; background:#111827; color:#e5e7eb; padding:10px; border-radius:0.75rem;"></pre>` +
                               `</div>`;
            let propsPanel = `<div id="${modalId}PropsPanel" style="display:none; height:100%;">` +
                               `<div style="display:flex; gap:8px; margin-bottom:8px;">` +
                               `<button class="btn btn-primary" id="${modalId}PropsFetchBtn">请求 props</button>` +
                               `</div>` +
                               `<pre id="${modalId}PropsViewer" style="height:calc(100% - 48px); overflow:auto; font-size:13px; background:#111827; color:#e5e7eb; padding:10px; border-radius:0.75rem;"></pre>` +
                               `</div>`;
            let bodyEnd = `</div>`;
            let wrapperEnd = `</div>`;
            content.innerHTML = wrapperStart + tabs + bodyStart + infoPanel + metricsPanel + propsPanel + bodyEnd + wrapperEnd;
            modal.classList.add('show');
            const tabInfo = document.getElementById(modalId + 'TabInfo');
            const tabMetrics = document.getElementById(modalId + 'TabMetrics');
            const tabProps = document.getElementById(modalId + 'TabProps');
            const fetchBtn = document.getElementById(modalId + 'MetricsFetchBtn');
            const fetchPropsBtn = document.getElementById(modalId + 'PropsFetchBtn');
            if (tabInfo) tabInfo.onclick = () => openModelDetailTab('info');
            if (tabMetrics) tabMetrics.onclick = () => { openModelDetailTab('metrics'); loadModelMetrics(); };
            if (tabProps) tabProps.onclick = () => { openModelDetailTab('props'); loadModelProps(); };
            if (fetchBtn) fetchBtn.onclick = () => loadModelMetrics();
            if (fetchPropsBtn) fetchPropsBtn.onclick = () => loadModelProps();
            openModelDetailTab('info');
        }
        
        function openModelDetailTab(tab) {
            const modalId = 'modelDetailModal';
            const info = document.getElementById(modalId + 'InfoPanel');
            const metrics = document.getElementById(modalId + 'MetricsPanel');
            const props = document.getElementById(modalId + 'PropsPanel');
            const btnInfo = document.getElementById(modalId + 'TabInfo');
            const btnMetrics = document.getElementById(modalId + 'TabMetrics');
            const btnProps = document.getElementById(modalId + 'TabProps');
            if (info) info.style.display = tab === 'info' ? '' : 'none';
            if (metrics) metrics.style.display = tab === 'metrics' ? '' : 'none';
            if (props) props.style.display = tab === 'props' ? '' : 'none';
            if (btnInfo) { btnInfo.classList.remove('btn-primary'); btnInfo.classList.add(tab === 'info' ? 'btn-primary' : 'btn-secondary'); }
            if (btnMetrics) { btnMetrics.classList.remove('btn-primary'); btnMetrics.classList.add(tab === 'metrics' ? 'btn-primary' : 'btn-secondary'); }
            if (btnProps) { btnProps.classList.remove('btn-primary'); btnProps.classList.add(tab === 'props' ? 'btn-primary' : 'btn-secondary'); }
        }
        
        function loadModelMetrics() {
            const modelId = window.__modelDetailModelId;
            const viewer = document.getElementById('modelDetailModalMetricsViewer');
            if (!modelId || !viewer) return;
            viewer.textContent = '加载中...';
            fetch('/api/models/metrics?modelId=' + encodeURIComponent(modelId))
                .then(r => r.json())
                .then(res => {
                    const d = res && res.success ? res.data : null;
                    const metrics = d && d.metrics ? d.metrics : null;
                    viewer.textContent = metrics ? JSON.stringify(metrics, null, 2) : JSON.stringify(res, null, 2);
                })
                .catch(() => {
                    viewer.textContent = '请求失败';
                });
        }
        
        function loadModelProps() {
            const modelId = window.__modelDetailModelId;
            const viewer = document.getElementById('modelDetailModalPropsViewer');
            if (!modelId || !viewer) return;
            viewer.textContent = '加载中...';
            fetch('/api/models/props?modelId=' + encodeURIComponent(modelId))
                .then(r => r.json())
                .then(res => {
                    const d = res && res.success ? res.data : null;
                    const props = d && d.props ? d.props : null;
                    viewer.textContent = props ? JSON.stringify(props, null, 2) : JSON.stringify(res, null, 2);
                })
                .catch(() => {
                    viewer.textContent = '请求失败';
                });
        }
        // 关闭对话框
        function closeModal(id) {
            const el = document.getElementById(id);
            if (el) el.classList.remove('show');
            if (id === 'consoleModal') stopConsoleAuto();
            if (id === 'loadModelModal') {
                document.getElementById('loadModelForm').reset();
                const btn = document.getElementById('modelActionSubmitBtn');
                if (btn) btn.disabled = false;
                setModelActionMode('load');
            }
        }
        
        // Window clicks
        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) {
                if (e.target.id === 'loadModelModal') {
                    if (window.__modelActionMode === 'config') closeModal('loadModelModal');
                } else {
                    closeModal(e.target.id);
                }
            }
        };

        function showToast(title, msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            const id = 'toast-' + Date.now();
            const html = `
                <div class="toast ${type}" id="${id}">
                    <div class="toast-icon"><i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i></div>
                    <div class="toast-content"><div class="toast-title">${title}</div><div class="toast-message">${msg}</div></div>
                    <button class="toast-close" onclick="document.getElementById('${id}').remove()">&times;</button>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
            setTimeout(() => { const el = document.getElementById(id); if (el) el.remove(); }, 5000);
        }
        
        // Alias Logic
         function openAliasModal(modelId, originalName, currentAlias) {
            const modalId = 'aliasModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div'); modal.id = modalId; modal.className = 'modal';
                modal.innerHTML = `<div class="modal-content" style="max-width:500px;"><div class="modal-header"><h3 class="modal-title">设置别名</h3><button class="modal-close" onclick="closeModal('${modalId}')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">原名</label><input class="form-control" id="aliasOriginalName" readonly></div><div class="form-group"><label class="form-label">别名</label><input class="form-control" id="aliasInput"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('${modalId}')">取消</button><button class="btn btn-primary" onclick="submitAlias()">保存</button></div></div>`;
                document.body.appendChild(modal);
            }
            window.__aliasEditingModelId = modelId;
            document.getElementById('aliasOriginalName').value = originalName;
            document.getElementById('aliasInput').value = currentAlias;
            modal.classList.add('show');
        }
        function submitAlias() {
            const modelId = window.__aliasEditingModelId;
            const alias = document.getElementById('aliasInput').value;
             fetch('/api/model/alias/set', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ modelId, alias })
            }).then(r => r.json()).then(d => {
                if (d.success) { showToast('成功', '别名已保存', 'success'); closeModal('aliasModal'); refreshModels(); }
                else { showToast('错误', d.error, 'error'); }
            });
        }
        
        // Settings Logic (simplified)
        function openSettingsModal() {
            loadSettings();
            loadLlamaCppList();
            document.getElementById('settingsModal').classList.add('show');
        }
        function openAddModelPathModal() {
            document.getElementById('addModelPathModal').classList.add('show');
        }
        function openAddLlamaCppPathModal() {
            document.getElementById('addLlamaCppPathModal').classList.add('show');
        }
        function loadSettings() {
             fetch('/api/setting').then(r => r.json()).then(d => {
                if (d.success) {
                    const paths = (d.data && d.data.modelPaths) ? d.data.modelPaths : [];
                    window.__modelPaths = paths;
                    renderModelPathList();
                }
            });
        }
        function renderModelPathList() {
            const c = document.getElementById('modelPathListContainer');
            const paths = window.__modelPaths || [];
            if (!paths.length) {
                c.innerHTML = `<div class="settings-empty">尚未配置任何目录</div>`;
                return;
            }
            c.innerHTML = paths.map(p => `
                <div class="settings-item">
                    <div class="settings-item-main">
                        <div class="settings-item-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <span class="settings-item-text" title="${p}">${p}</span>
                    </div>
                    <button type="button" class="btn-icon danger" onclick="removeModelPathItem('${p.replace(/\\/g, '\\\\')}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }
        function addModelPath() {
            const v = document.getElementById('addModelPathInput').value.trim();
            if (v) {
                if (!window.__modelPaths) window.__modelPaths = [];
                window.__modelPaths.push(v);
                renderModelPathList();
                document.getElementById('addModelPathInput').value = '';
                closeModal('addModelPathModal');
            }
        }
        function removeModelPathItem(p) {
             window.__modelPaths = window.__modelPaths.filter(x => x !== p);
             renderModelPathList();
        }
        function saveSettings() {
            fetch('/api/setting', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ modelPaths: window.__modelPaths })
            }).then(r => r.json()).then(d => {
                if(d.success) { showToast('成功', '设置已保存', 'success'); closeModal('settingsModal'); refreshModels(); }
                else showToast('错误', d.error, 'error');
            });
        }
        // LlamaCpp Path logic similar to above... (Skipped for brevity in this manual rewrite, but should be included)
        function loadLlamaCppList() {
             fetch('/api/llamacpp/list').then(r => r.json()).then(d => {
                 if (d.success) {
                     window.__llamaPaths = d.data.paths || [];
                     renderLlamaPathList();
                 }
             });
        }
        function renderLlamaPathList() {
            const c = document.getElementById('llamaCppListContainer');
            const paths = window.__llamaPaths || [];
            if (!paths.length) {
                c.innerHTML = `<div class="settings-empty">尚未配置任何路径</div>`;
                return;
            }
            c.innerHTML = paths.map(p => `
                <div class="settings-item">
                    <div class="settings-item-main">
                        <div class="settings-item-icon">
                            <i class="fas fa-microchip"></i>
                        </div>
                        <span class="settings-item-text" title="${p}">${p}</span>
                    </div>
                    <button type="button" class="btn-icon danger" onclick="removeLlamaCppPathItem('${p.replace(/\\/g, '\\\\')}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }
        function addLlamaCppPath() {
             const v = document.getElementById('addLlamaCppPathInput').value.trim();
             if(v) {
                 fetch('/api/llamacpp/add', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({path:v}) })
                 .then(r=>r.json()).then(d=>{ if(d.success) { loadLlamaCppList(); document.getElementById('addLlamaCppPathInput').value=''; closeModal('addLlamaCppPathModal'); } else showToast('错误', d.error, 'error'); });
             }
        }
        function removeLlamaCppPathItem(p) {
             fetch('/api/llamacpp/remove', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({path:p}) })
                 .then(r=>r.json()).then(d=>{ if(d.success) loadLlamaCppList(); else showToast('错误', d.error, 'error'); });
        }
        
        function shutdownService() {
            if (confirm('确定要停止服务吗？')) {
                fetch('/api/shutdown', { method: 'POST' }).then(r=>r.json()).then(d => {
                    if (d.success) {
                        document.body.innerHTML = '<div style="width: 100%;display:flex;justify-content:center;align-items:center;height:100vh;"><h1>服务已停止</h1></div>';
                    }
                });
            }
        }
        
        function filterModels(k) {
            k = k.toLowerCase();
            document.querySelectorAll('.model-item').forEach(el => {
                const name = el.querySelector('.model-name').textContent.toLowerCase();
                el.style.display = name.includes(k) ? '' : 'none';
            });
        }
        function initModelSearch() {
            document.getElementById('modelSearchInput').addEventListener('input', (e) => filterModels(e.target.value));
        }
    </script>
    <script src="js/model-list.js"></script>
    <script src="js/model-action-modal.js"></script>
    <script src="js/model-benchmark.js"></script>
</body>
</html>
