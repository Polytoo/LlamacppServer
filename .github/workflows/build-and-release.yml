name: Build and Release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: éªŒè¯ Java ç‰ˆæœ¬
        run: |
          echo "Java ç‰ˆæœ¬:"
          java -version
          javac -version

      - name: åˆ›å»ºæ„å»ºç›®å½•
        run: |
          mkdir -p build/classes
          mkdir -p build/lib

      - name: å¤åˆ¶ä¾èµ–é¡¹åˆ° build/lib
        run: |
          cp lib/*.jar build/lib/
          echo "å¤åˆ¶ä¾èµ–é¡¹:"
          ls -lh build/lib/

      - name: æ„å»º classpath
        run: |
          CLASSPATH=""
          for jar in lib/*.jar; do
            if [ -z "$CLASSPATH" ]; then
              CLASSPATH="$jar"
            else
              CLASSPATH="$CLASSPATH:$jar"
            fi
          done
          echo "CLASSPATH=$CLASSPATH" >> $GITHUB_ENV

      - name: ç¼–è¯‘ Java æºç 
        run: |
          find src/main/java -name "*.java" -print0 | xargs -0 javac \
            -source 21 \
            -target 21 \
            -encoding UTF-8 \
            -d build/classes \
            -cp "$CLASSPATH"

      - name: å¤åˆ¶ resources åˆ° classes ç›®å½•
        run: |
          if [ -d "src/main/resources" ]; then
            cp -r src/main/resources/* build/classes/
            echo "å·²å¤åˆ¶ resources åˆ° classes ç›®å½•"
            echo "classes ç›®å½•å†…å®¹:"
            ls -la build/classes/
          else
            echo "resources ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤åˆ¶"
          fi

      - name: éªŒè¯ç¼–è¯‘ç»“æœ
        run: |
          echo "ç¼–è¯‘è¾“å‡ºæ–‡ä»¶:"
          find build/classes -type f | head -20
          echo "æ€»æ–‡ä»¶æ•°:"
          find build/classes -type f | wc -l

      - name: ä¸‹è½½ç²¾ç®€ç‰ˆ JRE (Linux)
        run: |
          mkdir -p jre-linux
          curl -L -o jre-linux.zip https://github.com/IIIIIllllIIIIIlllll/Mini-JRE/releases/download/v1.0.0/mini-jre-21.08-linux-x64.zip
          unzip -q jre-linux.zip -d jre-linux
          JRE_NAME=$(ls jre-linux | head -1)
          mv jre-linux/$JRE_NAME jre-linux/jre
          chmod +x jre-linux/jre/bin/java
          rm jre-linux.zip
          echo "Linux JRE ä¸‹è½½å®Œæˆ"

      - name: ä¸‹è½½ç²¾ç®€ç‰ˆ JRE (Windows)
        run: |
          mkdir -p jre-win
          curl -L -o jre-win.zip https://github.com/IIIIIllllIIIIIlllll/Mini-JRE/releases/download/v1.0.0/mini-jre-21.08-win-x64.zip
          unzip -q jre-win.zip -d jre-win
          JRE_NAME=$(ls jre-win | head -1)
          mv jre-win/$JRE_NAME jre-win/jre
          rm jre-win.zip
          echo "Windows JRE ä¸‹è½½å®Œæˆ"

      - name: åˆ›å»ºå¯åŠ¨è„šæœ¬ (Linux/Mac)
        run: |
          cat > build/run.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          chmod +x ./jre/bin/java
          ./jre/bin/java -Xms64m -Xmx64m -classpath "./classes:./lib/*" org.mark.llamacpp.server.LlamaServer "$@"
          EOF
          chmod +x build/run.sh

      - name: åˆ›å»ºå¯åŠ¨è„šæœ¬ (Windows)
        run: |
          cat > build/run.bat << 'EOF'
          @echo off
          cd /d "%~dp0"
          start "" jre\bin\javaw.exe -Xms64m -Xmx64m -classpath "./classes;./lib/*" org.mark.llamacpp.server.LlamaServer %*

          EOF

      - name: å¤åˆ¶ README åˆ° build ç›®å½•
        run: |
          if [ -f README.md ]; then
            cp README.md build/
          fi

      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $VERSION"

      - name: è·å– llama.cpp Releases åˆ—è¡¨
        run: |
          curl -fsSL "https://api.github.com/repos/ggml-org/llama.cpp/releases?per_page=50" -o llama_releases.json

      - name: ä¸‹è½½ llama.cpp é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼ˆè‡ªåŠ¨é™çº§ï¼‰
        id: download_llamacpp
        run: |
          mkdir -p build/llamacpp

          TAGS=$(python3 - << 'PY'
          import json
          with open("llama_releases.json","r",encoding="utf-8") as f:
              releases = json.load(f)
          tags = [r.get("tag_name","") for r in releases if r.get("tag_name")]
          print(" ".join(tags))
          PY
          )

          if [ -z "$TAGS" ]; then
            echo "æ— æ³•è·å– llama.cpp releases åˆ—è¡¨"
            exit 1
          fi

          flatten_one_level_dir() {
            local target_dir="$1"
            local inner_dir
            inner_dir=$(find "$target_dir" -maxdepth 1 -mindepth 1 -type d | head -1 || true)
            if [ -n "$inner_dir" ]; then
              shopt -s dotglob
              mv "$inner_dir"/* "$target_dir"/
              rmdir "$inner_dir" || true
              shopt -u dotglob
            fi
          }

          try_download() {
            local backend="$1"
            local asset_template="$2"
            local archive_name="$3"
            local out_dir="$4"
            local extract_kind="$5"
            local optional_extra_asset="$6"
            local optional_extra_archive="$7"

            for tag in $TAGS; do
              local asset="${asset_template/\{tag\}/$tag}"
              local url="https://github.com/ggml-org/llama.cpp/releases/download/${tag}/${asset}"
              echo "[$backend] å°è¯•ä¸‹è½½: $url"
              if curl -fL -o "$archive_name" "$url"; then
                mkdir -p "$out_dir"
                if [ "$extract_kind" = "zip" ]; then
                  unzip -q "$archive_name" -d "$out_dir"
                else
                  tar -xzf "$archive_name" -C "$out_dir"
                fi
                rm -f "$archive_name"
                flatten_one_level_dir "$out_dir"

                if [ -n "$optional_extra_asset" ] && [ -n "$optional_extra_archive" ]; then
                  local extra_url="https://github.com/ggml-org/llama.cpp/releases/download/${tag}/${optional_extra_asset}"
                  echo "[$backend] å°è¯•ä¸‹è½½é™„åŠ ä¾èµ–: $extra_url"
                  if curl -fL -o "$optional_extra_archive" "$extra_url"; then
                    mkdir -p "${out_dir}-tmp-extra"
                    unzip -q "$optional_extra_archive" -d "${out_dir}-tmp-extra"
                    rm -f "$optional_extra_archive"
                    local extra_inner
                    extra_inner=$(find "${out_dir}-tmp-extra" -maxdepth 1 -mindepth 1 -type d | head -1 || true)
                    shopt -s dotglob
                    if [ -n "$extra_inner" ]; then
                      mv "$extra_inner"/* "$out_dir"/
                    else
                      mv "${out_dir}-tmp-extra"/* "$out_dir"/ || true
                    fi
                    shopt -u dotglob
                    rm -rf "${out_dir}-tmp-extra"
                  fi
                fi

                echo "${backend}_TAG=$tag" >> $GITHUB_ENV
                echo "${backend}_AVAILABLE=1" >> $GITHUB_ENV
                echo "[$backend] ä¸‹è½½å®Œæˆï¼Œä½¿ç”¨ tag: $tag"
                return 0
              fi
              rm -f "$archive_name" || true
            done

            echo "${backend}_AVAILABLE=0" >> $GITHUB_ENV
            echo "[$backend] æœªæ‰¾åˆ°å¯ä¸‹è½½çš„ç‰ˆæœ¬ï¼Œå·²è·³è¿‡"
            return 0
          }

          try_download "WIN_CUDA12" "llama-{tag}-bin-win-cuda-12.4-x64.zip" "llama-win-cuda12.zip" "win-cuda12" "zip" "cudart-llama-bin-win-cuda-12.4-x64.zip" "cudart-win-cuda12.zip"
          try_download "WIN_CUDA13" "llama-{tag}-bin-win-cuda-13.1-x64.zip" "llama-win-cuda13.zip" "win-cuda13" "zip" "cudart-llama-bin-win-cuda-13.1-x64.zip" "cudart-win-cuda13.zip"
          try_download "WIN_VULKAN" "llama-{tag}-bin-win-vulkan-x64.zip" "llama-win-vulkan.zip" "win-vulkan" "zip" "" ""
          try_download "WIN_HIP" "llama-{tag}-bin-win-hip-radeon-x64.zip" "llama-win-hip.zip" "win-hip" "zip" "" ""
          try_download "UBUNTU_VULKAN" "llama-{tag}-bin-ubuntu-vulkan-x64.tar.gz" "llama-ubuntu-vulkan.tar.gz" "ubuntu-vulkan" "tar" "" ""

      - name: æ‰“åŒ…ï¼ˆæŒ‰å®é™…ä¸‹è½½åˆ°çš„åç«¯åŠ¨æ€ç”Ÿæˆï¼‰
        id: package
        run: |
          mkdir -p dist

          make_zip() {
            local work_dir="$1"
            local root_name="$2"
            local zip_name="$3"
            mv "$work_dir" "$root_name"
            zip -r "dist/$zip_name" "$root_name"
          }

          cp -r build build-linux-no-llamacpp
          cp -r jre-linux/jre build-linux-no-llamacpp/jre
          mkdir -p build-linux-no-llamacpp/llamacpp
          make_zip "build-linux-no-llamacpp" "llama-server-${VERSION}-linux" "llama-server-${VERSION}-linux.zip"

          cp -r build build-win-no-llamacpp
          cp -r jre-win/jre build-win-no-llamacpp/jre
          mkdir -p build-win-no-llamacpp/llamacpp
          make_zip "build-win-no-llamacpp" "llama-server-${VERSION}-windows" "llama-server-${VERSION}-windows.zip"

          if [ "${UBUNTU_VULKAN_AVAILABLE:-0}" = "1" ]; then
            cp -r build build-linux-vulkan
            cp -r jre-linux/jre build-linux-vulkan/jre
            mkdir -p build-linux-vulkan/llamacpp
            cp -r ubuntu-vulkan build-linux-vulkan/llamacpp/
            make_zip "build-linux-vulkan" "llama-server-${VERSION}-${UBUNTU_VULKAN_TAG}-linux-vulkan" "llama-server-${VERSION}-${UBUNTU_VULKAN_TAG}-linux-vulkan.zip"
          fi

          if [ "${WIN_CUDA12_AVAILABLE:-0}" = "1" ]; then
            cp -r build build-win-cuda12
            cp -r jre-win/jre build-win-cuda12/jre
            mkdir -p build-win-cuda12/llamacpp
            cp -r win-cuda12 build-win-cuda12/llamacpp/
            make_zip "build-win-cuda12" "llama-server-${VERSION}-${WIN_CUDA12_TAG}-windows-cuda12" "llama-server-${VERSION}-${WIN_CUDA12_TAG}-windows-cuda12.zip"
          fi

          if [ "${WIN_CUDA13_AVAILABLE:-0}" = "1" ]; then
            cp -r build build-win-cuda13
            cp -r jre-win/jre build-win-cuda13/jre
            mkdir -p build-win-cuda13/llamacpp
            cp -r win-cuda13 build-win-cuda13/llamacpp/
            make_zip "build-win-cuda13" "llama-server-${VERSION}-${WIN_CUDA13_TAG}-windows-cuda13" "llama-server-${VERSION}-${WIN_CUDA13_TAG}-windows-cuda13.zip"
          fi

          if [ "${WIN_VULKAN_AVAILABLE:-0}" = "1" ]; then
            cp -r build build-win-vulkan
            cp -r jre-win/jre build-win-vulkan/jre
            mkdir -p build-win-vulkan/llamacpp
            cp -r win-vulkan build-win-vulkan/llamacpp/
            make_zip "build-win-vulkan" "llama-server-${VERSION}-${WIN_VULKAN_TAG}-windows-vulkan" "llama-server-${VERSION}-${WIN_VULKAN_TAG}-windows-vulkan.zip"
          fi

          if [ "${WIN_HIP_AVAILABLE:-0}" = "1" ]; then
            cp -r build build-win-hip
            cp -r jre-win/jre build-win-hip/jre
            mkdir -p build-win-hip/llamacpp
            cp -r win-hip build-win-hip/llamacpp/
            make_zip "build-win-hip" "llama-server-${VERSION}-${WIN_HIP_TAG}-windows-hip" "llama-server-${VERSION}-${WIN_HIP_TAG}-windows-hip.zip"
          fi


      - name: ç”Ÿæˆ Release Notes
        id: release_notes
        run: |
          # è·å–æœ€æ–°çš„ commit ä¿¡æ¯
          LATEST_COMMIT=$(git log -1 --pretty=format:"%h - %s (%an, %ar)")
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%B")
          
          # è·å–è‡ªä¸Šä¸€ä¸ª tag ä»¥æ¥çš„æ‰€æœ‰ commit
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            COMMITS_SINCE_TAG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS_SINCE_TAG=$(git log --pretty=format:"- %s (%h)" --no-merges | head -20)
          fi
          
          LINUX_ZIPS=$(ls dist/*linux*.zip 2>/dev/null || true)
          WINDOWS_ZIPS=$(ls dist/*windows*.zip 2>/dev/null || true)

          cat > release_notes.md << 'EOF'
          ## ğŸš€ Release Notes
          
          ### ğŸ“¦ åŒ…å«å†…å®¹
          - ç¼–è¯‘åçš„ class æ–‡ä»¶
          - æ‰€æœ‰ä¾èµ–åº“ï¼ˆlib/*.jarï¼‰
          - ç²¾ç®€ç‰ˆ JRE 21.08ï¼ˆå†…ç½®ï¼Œæ— éœ€å®‰è£… Javaï¼‰
          - å¯åŠ¨è„šæœ¬ï¼ˆrun.sh / run.batï¼‰

          ### ğŸ§© llama.cpp ç‰ˆæœ¬ï¼ˆæŒ‰åç«¯åˆ†åˆ«è‡ªåŠ¨é™çº§ï¼‰
          EOF

          ANY_BACKEND=0

          if [ "${UBUNTU_VULKAN_AVAILABLE:-0}" = "1" ]; then
            echo "- Linux Vulkan: ${UBUNTU_VULKAN_TAG}" >> release_notes.md
            ANY_BACKEND=1
          fi
          if [ "${WIN_CUDA12_AVAILABLE:-0}" = "1" ]; then
            echo "- Windows CUDA12: ${WIN_CUDA12_TAG}" >> release_notes.md
            ANY_BACKEND=1
          fi
          if [ "${WIN_CUDA13_AVAILABLE:-0}" = "1" ]; then
            echo "- Windows CUDA13: ${WIN_CUDA13_TAG}" >> release_notes.md
            ANY_BACKEND=1
          fi
          if [ "${WIN_VULKAN_AVAILABLE:-0}" = "1" ]; then
            echo "- Windows Vulkan: ${WIN_VULKAN_TAG}" >> release_notes.md
            ANY_BACKEND=1
          fi
          if [ "${WIN_HIP_AVAILABLE:-0}" = "1" ]; then
            echo "- Windows HIP: ${WIN_HIP_TAG}" >> release_notes.md
            ANY_BACKEND=1
          fi
          if [ "$ANY_BACKEND" = "0" ]; then
            echo "- æ— " >> release_notes.md
          fi

          echo "" >> release_notes.md
          echo "### ğŸ“¦ å¯ç”¨ç‰ˆæœ¬" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Linux:**" >> release_notes.md
          if [ -n "$LINUX_ZIPS" ]; then
            while IFS= read -r f; do
              [ -n "$f" ] && echo "- \`$(basename "$f")\`" >> release_notes.md
            done <<< "$LINUX_ZIPS"
          else
            echo "- æ— " >> release_notes.md
          fi

          echo "" >> release_notes.md
          echo "**Windows:**" >> release_notes.md
          if [ -n "$WINDOWS_ZIPS" ]; then
            while IFS= read -r f; do
              [ -n "$f" ] && echo "- \`$(basename "$f")\`" >> release_notes.md
            done <<< "$WINDOWS_ZIPS"
          else
            echo "- æ— " >> release_notes.md
          fi

          cat >> release_notes.md << 'EOF'

          ### ğŸ“ ä½¿ç”¨æ–¹æ³•
          
          **Linux:**
          ```bash
          unzip <ä½ ä¸‹è½½çš„ linux zip åŒ…>
          cd <è§£å‹åçš„ç›®å½•>
          chmod +x run.sh
          chmod +x jre/bin/java
          ./run.sh
          ```
          
          **Windows:**
          ```cmd
          unzip <ä½ ä¸‹è½½çš„ windows zip åŒ…>
          cd <è§£å‹åçš„ç›®å½•>
          run.bat
          ```
          
          **æ³¨æ„ï¼š**
          - æœ¬ç‰ˆæœ¬å·²å†…ç½®ç²¾ç®€ç‰ˆ JREï¼Œæ— éœ€é¢å¤–å®‰è£… Java ç¯å¢ƒã€‚
          - è¯·æ ¹æ®ä½ çš„ GPU é€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ï¼š
            - NVIDIA GPU: ä½¿ç”¨ cuda12 æˆ– cuda13 ç‰ˆæœ¬
            - AMD GPU: ä½¿ç”¨ hip ç‰ˆæœ¬
            - å…¶ä»– GPUï¼ˆå¦‚æ ¸æ˜¾ï¼‰ æˆ–ä¸ç¡®å®š: ä½¿ç”¨ vulkan ç‰ˆæœ¬
            - ä¸éœ€è¦llamacppï¼šä½¿ç”¨æ—  llamacpp ç‰ˆæœ¬
          ---

          ### ğŸ“Œ æœ€æ–°æäº¤
          EOF
          
          echo "$LATEST_COMMIT" >> release_notes.md
          echo "" >> release_notes.md
          
          # æ·»åŠ æäº¤è¯¦æƒ…
          if [ -n "$COMMITS_SINCE_TAG" ]; then
            echo "### ğŸ“‹ è‡ªä¸Šæ¬¡å‘å¸ƒä»¥æ¥çš„å˜æ›´" >> release_notes.md
            echo "" >> release_notes.md
            echo "$COMMITS_SINCE_TAG" >> release_notes.md
          fi
          
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "*æ„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> release_notes.md
          
          # è¾“å‡ºå†…å®¹ä¾›è°ƒè¯•
          echo "ç”Ÿæˆçš„ Release Notes:"
          cat release_notes.md

      - name: åˆ›å»º Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.zip
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: llama-server-${{ steps.get_version.outputs.version }}
          path: |
            dist/*.zip
            release_notes.md
          retention-days: 30

